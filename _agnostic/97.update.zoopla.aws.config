#!/bin/bash
# https://stackoverflow.com/a/7522866
if ! type "aws" >/dev/null; then
    # no aws; nothing to do
    true
elif [ ! -d ~/.aws ]; then
    # no aws directory .. better to leave well alone
    true
else
    host="${HOST}"
    if [ -z "${host}" ]; then
        host="$(hostname)"
    fi

    # we might want to toggle between vanilla and SSO
    # default to using SSO
    USE_AWS_SSO=${USE_AWS_SSO:-1}

    # filename changes slightly
    if [ "${USE_AWS_SSO}" = "1" ]; then
        CONFIG_FILENAME_PREFIX="awscli_sso_config"
        [[ -f ~/.aws/credentials ]] && mv -v ~/.aws/credentials{,.pre-sso}
    else
        [[ -f ~/.aws/credentials.pre-sso ]] && mv -v ~/.aws/credentials{.pre-sso,}
        CONFIG_FILENAME_PREFIX="awscli_config"
    fi

    # only do this if it looks like we're on a zoopla box
    case $host in
        macbook.zoopla|Chisels-MacBook-Air.local|*.dev.uk|chisel-zpg.local|*.eu-west-1.compute.internal)
            # make sure the ~/.aws/config is up to date
            curl -so ~/.aws/config "https://gitlab.zoopla.co.uk/infrastructure/wiki/-/raw/master/multiaccount/${CONFIG_FILENAME_PREFIX}.txt"
            # we also now grab "config by id"
            curl -so ~/.aws/config-by-id "https://gitlab.zoopla.co.uk/infrastructure/wiki/-/raw/master/multiaccount/${CONFIG_FILENAME_PREFIX}_by_accountid.txt"

            # if using aws-sso, assume we're using aws-vault, and add the empty profile block we will have wiped out with the downloadgqq
            if [ "${USE_AWS_SSO}" = "1" ]; then
                for f in ~/.aws/config*; do
                    echo -e "\n\n[profile chisel.malik-wright]" >> "${f}"
                done
            fi
            ;;
    esac
fi
